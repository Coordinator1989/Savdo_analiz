<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
      body { font-family: Arial; text-align: center; padding: 10px; }
      #reader { width: 300px; margin: auto; }
      .modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        width: 300px;
        text-align: left;
      }
      input, select {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        font-size: 16px;
      }
      button {
        padding: 10px 15px;
        font-size: 16px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h2>üì¶ QR orqali Chiqim qilish</h2>
    <div id="reader"></div>
    <div id="result"></div>

    <div class="modal" id="productModal">
      <div class="modal-content">
        <p><b id="productInfoText"></b></p>
        <input id="quantity" type="number" placeholder="Miqdori">
        <input id="price" type="number" placeholder="Narxi">
        <input id="salePrice" type="number" placeholder="Sotish narxi">
        <select id="branchSelect"></select>
        <button onclick="confirmData()">‚úÖ Tasdiqlash</button>
      </div>
    </div>

    <script>
      let html5QrCode;
      let currentCode = '';
      let productName = '';

      function startScanner() {
        Html5Qrcode.getCameras().then(cameras => {
          if (cameras.length) {
            const backCam = cameras.find(c =>
              c.label.toLowerCase().includes("back") ||
              c.label.toLowerCase().includes("rear") ||
              c.label.toLowerCase().includes("zad")
            ) || cameras[0];
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(backCam.id, { fps: 10, qrbox: 250 }, onScanSuccess);
          } else {
            document.getElementById("result").innerText = "‚ùå Kamera topilmadi";
          }
        }).catch(err => {
          document.getElementById("result").innerText = "‚ö†Ô∏è Kamera xatosi: " + err;
        });
      }

      function onScanSuccess(decodedText) {
        html5QrCode.stop();
        currentCode = decodedText;
        document.getElementById("result").innerText = "üîç Tekshirilmoqda...";

        google.script.run
          .withSuccessHandler(handleProductInfo)
          .getProductInfoByCode(decodedText);
      }

      function handleProductInfo(info) {
        if (!info) {
          if (confirm("üÜï Yangi mahsulot. Qo‚Äòshilsinmi?")) {
            const name = prompt("Mahsulot nomi:");
            if (name) {
              google.script.run.addNewProduct(currentCode, name);
              alert("‚úÖ Katalogga qo‚Äòshildi. Qayta skanerlashni boshlang.");
              startScanner();
            }
          } else {
            startScanner();
          }
          return;
        }

        productName = info.name;
        document.getElementById("productInfoText").innerText = `${info.name} (${info.code})`;
        document.getElementById("price").value = info.price || '';
        document.getElementById("salePrice").value = info.salePrice || '';
        document.getElementById("quantity").value = '';

        // Filiallar ro‚Äòyxatini yuklaymiz
        google.script.run.withSuccessHandler(fillBranches).getBranches();

        document.getElementById("productModal").style.display = "flex";
      }

      function fillBranches(branches) {
        const select = document.getElementById("branchSelect");
        select.innerHTML = '<option value="">--Filial tanlang--</option>';
        branches.forEach(branch => {
          const opt = document.createElement("option");
          opt.value = branch;
          opt.textContent = branch;
          select.appendChild(opt);
        });
      }

      function confirmData() {
        const qty = parseFloat(document.getElementById("quantity").value);
        const price = parseFloat(document.getElementById("price").value);
        const sale = parseFloat(document.getElementById("salePrice").value);
        const branch = document.getElementById("branchSelect").value;

        if (!qty || !price || !sale || !branch) {
          alert("‚ùó Hammasini to‚Äòldiring!");
          return;
        }

        google.script.run
          .withSuccessHandler(() => {
            alert("‚úÖ Saqlandi");
            document.getElementById("productModal").style.display = "none";
            startScanner();
          })
          .saveProduct({
            code: currentCode,
            name: productName,
            quantity: qty,
            price: price,
            salePrice: sale,
            branch: branch
          });
      }

      window.onload = startScanner;
    </script>
  </body>
</html>
