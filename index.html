<!-- index.html (GitHub Pages uchun) -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#3367D6">
    <link rel="manifest" href="manifest.json">
    <title>QR Chiqim PWA</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
      body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; }
      #reader { width: 300px; margin: 20px auto; }
      input, select, button { margin: 5px; padding: 10px; font-size: 16px; width: 80%; }
      .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
      .modal-content { background: #fff; padding: 20px; border-radius: 10px; text-align: left; width: 300px; }
    </style>
  </head>
  <body>
    <h2>üì¶ QR Chiqim</h2>
    <div id="reader"></div>

    <div class="modal" id="formModal">
      <div class="modal-content">
        <p id="productName"></p>
        <input type="number" id="quantity" placeholder="Miqdori">
        <input type="number" id="price" placeholder="Narxi">
        <input type="number" id="salePrice" placeholder="Sotish narxi">
        <select id="filial">
          <option value="">Filialni tanlang</option>
        </select>
        <button onclick="submitData()">‚úÖ Saqlash</button>
      </div>
    </div>

    <script>
      let html5QrCode = new Html5Qrcode("reader");
      let currentCode = "";

      async function startScanner() {
        const backcameras = await Html5Qrcode.getCameras();
        if (cameras.length) {
          html5QrCode.start(cameras[0].id, { fps: 10, qrbox: 250 }, onScan);
        }
      }

      async function onScan(code) {
        html5QrCode.stop();
        currentCode = code;
        const response = await fetch("https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbymU3YvA0vBSQLzFm4yamw7YISAmaGnUI_9WsOxcCRk-irZJlhhFYcRKOea_ptEw3L5eA/exec/exec?code=" + code);
        const data = await response.json();

        if (!data.found) {
          alert("‚ùå Mahsulot topilmadi. Avval katalogga qo‚Äòshing.");
          startScanner();
        } else {
          document.getElementById("productName").innerText = `${data.name} (${data.code})`;
          document.getElementById("price").value = data.price;
          loadFilials();
          document.getElementById("formModal").style.display = "flex";
        }
      }

      async function loadFilials() {
        const res = await fetch("https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbymU3YvA0vBSQLzFm4yamw7YISAmaGnUI_9WsOxcCRk-irZJlhhFYcRKOea_ptEw3L5eA/exec/exec?filials=true");
        const list = await res.json();
        const select = document.getElementById("filial");
        select.innerHTML = '<option value="">Filialni tanlang</option>' + list.map(f => `<option value="${f}">${f}</option>`).join('');
      }

      async function submitData() {
        const payload = {
          code: currentCode,
          quantity: document.getElementById("quantity").value,
          price: document.getElementById("price").value,
          salePrice: document.getElementById("salePrice").value,
          filial: document.getElementById("filial").value
        };

        if (!payload.quantity || !payload.price || !payload.salePrice || !payload.filial) {
          alert("Barcha maydonlarni to‚Äòldiring!");
          return;
        }

        const res = await fetch("https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbymU3YvA0vBSQLzFm4yamw7YISAmaGnUI_9WsOxcCRk-irZJlhhFYcRKOea_ptEw3L5eA/exec/exec", {
          method: "POST",
          body: JSON.stringify(payload)
        });

        const result = await res.text();
        alert(result);
        document.getElementById("formModal").style.display = "none";
        startScanner();
      }

      startScanner();

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>
  </body>
</html>
